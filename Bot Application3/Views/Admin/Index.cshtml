@using Bot.model
@using Newtonsoft.Json;
@{
    ViewBag.Title = "Index";
}
<style>
       .wrap {
        float: left;
        width: 200px;
        margin-right: 50px;
    }

    .user_list {
        float: left;
        width: 800px;
        height: 800px;
        border-left: 1px solid blue;
    }

    .dialog {
        float: left;
        background-color: aqua;
        width: 500px;
        clear: both;
        margin-bottom: 20px;
    }

    .chat_box {
        position: fixed;
        bottom: 0;
    }

    .IsAuto {
    margin-left:20px;
    border:0;
    }
       

    .userItem {
    margin-bottom:10px;
    }

    .enabled {
    background-color:cornflowerblue;
    }
     .disabled {
    background-color:lightgray;
    }
</style>
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<script type="text/javascript">
    $(function () {
        loadUsers();
    });

    var intervals = [];
    var currentUser = null;
    function loadChat(userInfo) {
        //clear all intervals
        while (intervals.length > 0) {
            window.clearInterval(intervals.pop());
        }
        $("#chatRoom").html("");
        currentUser = userInfo;
        intervals.push(
            setInterval(function () {
                getMessage(userInfo);
            }, 500));
    }
    function getMessage(userInfo) {
        var customerId = $(userInfo).attr("customerId");
        $.ajax({
            type: "GET",
            url: "/admin/GetMessages",
            data: "customerId=" + customerId + "&watermark=" + $(userInfo).attr("watermark"),
            dataType: "json",
            success: function (msg) {
                $(userInfo).attr("watermark", msg.watermark);
                for (var i = 0; i < msg.activities.length; i++) {
                    var activity = msg.activities[i];
                    var flag = customerId == activity.from.id;
                    if ($("#chatRoom div[id='" + activity.id + "']").length > 0) {
                        continue;
                    }
                    //$("#chatRoom").append("<div class='dialog' id='"+activity.id+"' style='float:" + (flag ? "left" : "right") + "'>" + activity.text + "</div>");
                    var $divTxtBox = $("<div class='dialog'></div>").css("float", flag ? "left" : "right").attr("id", activity.id).appendTo($("#chatRoom"));

                    var $divTxt = $("<div></div>").text(activity.text).appendTo($divTxtBox);
                    if ($(currentUser).attr("adminEnable") == "true" && flag) {
                        $.ajax({
                            type: "get",
                            url: "/admin/GetIntelligence",
                            data: "question=" + activity.text,
                            dataType: "json",
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(errorThrown);
                                alert(XMLHttpRequest);
                                alert(textStatus);

                            },
                            success: function (msg) {
                                if (msg.count > 0) {
                                    var result = "";
                                    for (var i = 0; i < msg.content.length; i++) {
                                        result += "<p>" + msg.content[i] + "</p>";
                                    }
                                    var $tip = $("<div></div>").css("backgroundColor", "yellow").appendTo($divTxtBox).html(result);
                                }
                            }
                        });
                    }
                }
            }

        });
    }
    function sendMessage() {
        $(currentUser).attr("adminEnable", "true")
        $.ajax({
            type: "POST",
            url: "/admin",
            data: "customerId=" + $("#test").attr("customerId") + "&content=" + $("#message").val(),
            dataType: "json",
            success: function (msg) {

            }

        });
    }

    function isEnable(ele, customerId) {
        var $ele = $(ele);
        var status = $ele[0].className.indexOf("enabled") == -1 ? true : false;
        $.ajax({
            type: "POST",
            url: "/admin/ChangeAutoStatus",
            data: { customerId: customerId, status: status },
            dataType: "json",
            success: function (msg) {
                if (!msg.status) {
                    $(ele).removeClass("enabled").addClass("disabled").text("托管");
                } else {
                    $(ele).removeClass("disabled").addClass("enabled").text("启用");;
                }
            }
        });

    }

    function loadUsers() {
        $.ajax({
            type: "GET",
            url: "/admin/GetUsers",
            dataType: "json",
            success: function (msg) {
                var userHtml = "";
                $.each(msg, function (i, item) {
                    var btnTxt = item.BotEnabled ? "启用" : "托管";
                    var btnClass = item.BotEnabled ? "enabled" : "disabled";
                    userHtml += '<div class="userItem"><span onclick="loadChat(this)" customerId=' + item.UserId + 'watermark="">' + item.Name + '</span><button class="IsAuto ' + btnClass + '" onclick="isEnable(this,\'' + item.UserId + '\')">' + btnTxt + '</button></div>';
                });
                $("#user").html(userHtml);
            }
        });

    }
</script>
<div style="height:800px;">
    <div id="user" class="wrap">
    </div>
    <div class="user_list">
        <div id="chatRoom">

        </div>
        <div id="chatInput" class="chat_box">
            <div style="float:left">
                <input type="text" id="message" value="" />
            </div>
            <div style="float:left">
                <input type="button" onclick="sendMessage()" value="send" />
            </div>
        </div>
    </div>
</div>


